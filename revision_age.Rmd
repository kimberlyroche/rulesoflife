---
title: "Age-based differences in CLR correlations"
author: "Kim Roche"
date: "2023-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rulesoflife)
library(ggplot2)
library(magrittr)
library(dplyr)
library(caret)
library(ggridges)
library(tidyverse)
library(kableExtra)

source("thresholds.R")

data <- load_data(tax_level = "ASV")
filter_obj <- filter_joint_zeros(data$counts)

age_pairs <- list(c(0, 6),
                  c(6, 13),
                  c(13, 30))

# Juvenile vs. prime age with minimum number of samples (n=35)
group1 <- c("ACA", "CAI", "DAS", "EAG", "ELV", "LIW",
            "MBE", "ONY", "OPH", "OXY", "PEB", "VAI", "WYN")

# Prime age vs. older adult with minimum number of samples (n=35)
group2 <- c("COB", "ECH", "GAB", "HOL", "LAD", "NAP",
            "NOB", "TAL", "VEI", "VET", "VIN", "WAD", "WHE")
```

We'll split into age ranges **juvenile** (0-6 years), **prime age adult** (6-13 
years), and **older adult** (13+ years).

Fit models for a handful of baboons for these ranges. We'll compare the CLR
ASV-ASV correlations that result from the age range-restricted models.

```{r, eval=F}
# This only needs to be run once

# Fit prime age models
for(sname in c(group1, group2)) {
  odir <- "asv_days90_diet25_scale1_age6-13"
  fit <- fit_GP(sname = sname,
                counts = data$counts,
                metadata = data$metadata,
                output_dir = odir,
                MAP = TRUE,
                days_to_min_autocorrelation = 90,
                diet_weight = 0.25,
                age_min = 6,
                age_max = 13,
                scramble_sample = F,
                scramble_spacing = F,
                scramble_order = F,
                use_adam = F)
}

# Fit juvenile models
for(sname in group1) {
  odir <- "asv_days90_diet25_scale1_age0-6"
  fit <- fit_GP(sname = sname,
                counts = data$counts,
                metadata = data$metadata,
                output_dir = odir,
                MAP = TRUE,
                days_to_min_autocorrelation = 90,
                diet_weight = 0.25,
                age_min = 0,
                age_max = 6,
                scramble_sample = F,
                scramble_spacing = F,
                scramble_order = F,
                use_adam = F)
}

# Fit older adult models
for(sname in group2) {
  odir <- "asv_days90_diet25_scale1_age13-30"
  fit <- fit_GP(sname = sname,
                counts = data$counts,
                metadata = data$metadata,
                output_dir = odir,
                MAP = TRUE,
                days_to_min_autocorrelation = 90,
                diet_weight = 0.25,
                age_min = 13,
                age_max = 30,
                scramble_sample = F,
                scramble_spacing = F,
                scramble_order = F,
                use_adam = F)
}
```

Look at correlation between juvenile and prime age adult estimates for ACA.

```{r, fig.height = 5, fig.width = 5}
sname <- group1[1]

est1 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age0-6/MAP/", sname, ".rds")))
sigma1 <- cov2cor(est1$Sigma[,,1])

est2 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age6-13/MAP/", sname, ".rds")))
sigma2 <- cov2cor(est2$Sigma[,,1])

plot_df <- data.frame(x = c(sigma1[lower.tri(sigma1, diag = F)]),
                      y = c(sigma2[lower.tri(sigma2, diag = F)]))

ggplot(plot_df, aes(x = x, y = y)) +
  geom_point() +
  xlim(c(-1,1)) +
  ylim(c(-1,1)) +
  theme_bw() +
  labs(x = "correlation (ages 0-6)",
       y = "correlation (ages 6-13)",
       title = paste0("R=", signif(cor(plot_df$x, plot_df$y), 2), " (", sname, ")"))
```

Look at correlation between prime age adult and older adult estimates for COB.

```{r, fig.height = 5, fig.width = 5}
sname <- group2[1]

est1 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age6-13/MAP/", sname, ".rds")))
sigma1 <- cov2cor(est1$Sigma[,,1])

est2 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age13-30/MAP/", sname, ".rds")))
sigma2 <- cov2cor(est2$Sigma[,,1])

plot_df <- data.frame(x = c(sigma1[lower.tri(sigma1, diag = F)]),
                      y = c(sigma2[lower.tri(sigma2, diag = F)]))

ggplot(plot_df, aes(x = x, y = y)) +
  geom_point() +
  xlim(c(-1,1)) +
  ylim(c(-1,1)) +
  theme_bw() +
  labs(x = "correlation (ages 6-13)",
       y = "correlation (ages 13-30)",
       title = paste0("R=", signif(cor(plot_df$x, plot_df$y), 2), " (", sname, ")"))
```

Look at a series of estimates for ACA.

```{r}
est <- fido::to_clr(readRDS("output/model_fits/asv_days90_diet25_scale1/MAP/ACA.rds"))
overall <- cov2cor(est$Sigma[,,1])

est <- fido::to_clr(readRDS("output/model_fits/asv_days90_diet25_scale1_age0-6/MAP/ACA.rds"))
juvenile <- cov2cor(est$Sigma[,,1])

est <- fido::to_clr(readRDS("output/model_fits/asv_days90_diet25_scale1_age6-13/MAP/ACA.rds"))
prime <- cov2cor(est$Sigma[,,1])

plot_kernel_or_cov_matrix(overall)
plot_kernel_or_cov_matrix(juvenile)
plot_kernel_or_cov_matrix(prime)
```

Build a "rug" object.

```{r}
pairs <- combn(1:125, m = 2)
pairs_df <- data.frame(idx1 = pairs[1,], idx2 = pairs[2,]) %>%
  left_join(filter_obj %>%
              select(idx1, idx2, threshold))
rug <- matrix(NA, length(group1)*2 + length(group2)*2, sum(filter_obj$threshold))
host_groups <- data.frame(index = 1:nrow(rug), sname = NA, group = NA)
for(i in 1:length(group1)) {
  sname <- group1[i]
  # Juvenile
  est1 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age0-6/MAP/", sname, ".rds")))
  sigma1 <- cov2cor(est1$Sigma[1:125,1:125,1])
  # Prime age
  est2 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age6-13/MAP/", sname, ".rds")))
  sigma2 <- cov2cor(est2$Sigma[1:125,1:125,1])
  
  rug[i,] <- c(sigma1[lower.tri(sigma1, diag = F)])[pairs_df$threshold]
  rug[(i+length(group1)),] <- c(sigma2[lower.tri(sigma2, diag = F)])[pairs_df$threshold]
  host_groups[i,]$sname <- sname
  host_groups[i,]$group <- "juvenile"
  host_groups[(i+length(group1)),]$sname <- sname
  host_groups[(i+length(group1)),]$group <- "prime"
}
offset <- length(group1)*2
for(i in 1:length(group2)) {
  sname <- group2[i]
  # Prime age
  est1 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age6-13/MAP/", sname, ".rds")))
  sigma1 <- cov2cor(est1$Sigma[1:125,1:125,1])
  # Older adult
  est2 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_age13-30/MAP/", sname, ".rds")))
  sigma2 <- cov2cor(est2$Sigma[1:125,1:125,1])
  
  rug[(offset+i),] <- c(sigma1[lower.tri(sigma1, diag = F)])[pairs_df$threshold]
  rug[(offset+i+length(group2)),] <- c(sigma2[lower.tri(sigma2, diag = F)])[pairs_df$threshold]
  host_groups[(offset+i),]$sname <- sname
  host_groups[(offset+i),]$group <- "prime"
  host_groups[(offset+i+length(group2)),]$sname <- sname
  host_groups[(offset+i+length(group2)),]$group <- "older"
}

d <- dist(rug)
d_mat <- as.matrix(d)
coords <- cmdscale(d, k = 2)
host_groups$x <- coords[,1]
host_groups$y <- coords[,2]

centroid_df <- host_groups %>%
  group_by(group) %>%
  summarize(x_mean = mean(x), y_mean = mean(y))

ggplot() +
  geom_point(data = host_groups,
             mapping = aes(x = x, y = y, fill = group),
             size = 3, shape = 21) +
  geom_point(data = centroid_df,
             mapping = aes(x = x_mean, y = y_mean, color = group),
             size = 3, shape = 7) +
  theme_bw() +
  labs(x = "PCA 1", y = "PCA 2", fill = "Age bin", color = "Age bin")
```

ANOVA: Does being in the same age bin explain some of the variation we see in 
correlation estimates (for filtered, high-confidence pairs)?

```{r}
hosts <- combn(1:52, m = 2)
dist_df <- data.frame(idx1 = hosts[1,], idx2 = hosts[2,])
dist_df$d <- d_mat[lower.tri(d_mat, diag = F)]

dist_df %<>%
  left_join(host_groups %>%
              select(index, sname, group),
            by = c("idx1" = "index")) %>%
  rename(sname1 = sname, group1 = group) %>%
  left_join(host_groups %>%
              select(index, sname, group),
            by = c("idx2" = "index")) %>%
  rename(sname2 = sname, group2 = group)
```

ANOVA: Juvenile vs. prime

```{r}
summary(aov(d ~ same_group, data = dist_df %>%
              mutate(same_group = group1 == group2) %>%
              filter(group1 %in% c("juvenile", "prime"),
                     group2 %in% c("juvenile", "prime"))))
```

ANOVA: Prime vs. older

```{r}
summary(aov(d ~ same_group, data = dist_df %>%
              mutate(same_group = group1 == group2) %>%
              filter(group1 %in% c("older", "prime"),
                     group2 %in% c("older", "prime"))))
```

Plot the "rug". Note that rows are juvenile (rows 1-13), prime age (rows 14-39),
and older adult (rows 40-52).

```{r}
col_order <- order(apply(rug, 2, median))
plot_rug <- rug[,col_order]

plot_rug <- cbind(1:nrow(plot_rug), plot_rug)
colnames(plot_rug) <- c("host", paste0(1:(ncol(plot_rug)-1)))
plot_rug <- pivot_longer(as.data.frame(plot_rug), !host, names_to = "pair", values_to = "correlation")
plot_rug$pair <- as.numeric(plot_rug$pair)

ggplot(plot_rug, aes(x = pair, y = host)) +
  geom_raster(aes(fill = correlation)) +
  scale_fill_gradient2(low = "navy", mid = "white", high = "red",
                       midpoint = 0) +
  labs(y = "") +
  theme_bw() +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "correlation\nmetric")
```

Do any pairs change their consensus sign across age bins? In "significantly"
universal pairs, there's 99.7% fidelity in sign between **juvenile** and **prime
age** years. Only 3 pairs are somewhat universal *and* change sign: from 
positively correlated in juvenile series to negatively correlated in prime age series.

```{r}
juvenile_consensus_sign <- apply(rug[host_groups$sname %in% group1 & host_groups$group == "juvenile",], 2, calc_consensus_sign)
prime_consensus_sign <- apply(rug[host_groups$sname %in% group1 & host_groups$group == "prime",], 2, calc_consensus_sign)
universality <- apply(rug[host_groups$sname %in% group1,], 2, calc_universality_score)
univ_threshold <- universality > thresholds_scores$x0[thresholds_scores$type == "ASV"]
juvenile_universal <- juvenile_consensus_sign[univ_threshold]
prime_universal <- prime_consensus_sign[univ_threshold]
confusionMatrix(factor(prime_universal),
                factor(juvenile_universal),
                positive = '1')

# Reference is juvenile
```

Who are these pairs? (These are not in the top 10% most universal pairs overall.
They generally have low universality scores of ~0.20.)

```{r}
univ_pairs_df <- pairs_df %>%
  filter(threshold)
univ_pairs_df <- univ_pairs_df[univ_threshold,]

idx <- which(juvenile_universal > 0 & prime_universal < 0)

univ_pairs_df[idx,] %>%
  select(-threshold) %>%
  left_join(data.frame(idx1 = 1:126,
                       order1 = data$taxonomy$order,
                       family1 = data$taxonomy$family,
                       genus1 = data$taxonomy$genus)) %>%
  left_join(data.frame(idx2 = 1:126,
                       order2 = data$taxonomy$order,
                       family2 = data$taxonomy$family,
                       genus2 = data$taxonomy$genus)) %>%
  rowwise() %>%
  mutate(tax1 = paste(order1, family1, genus1),
         tax2 = paste(order2, family2, genus2)) %>%
  select(idx1, idx2, tax1, tax2) %>%
  kbl() %>%
  kable_styling()

# universality[univ_threshold][idx]
```

In "significantly" universal pairs, there's 99.2% fidelity in sign between 
**prime age** and **older adult**. Seven pairs are somewhat universal *and* 
change sign.

```{r}
prime_consensus_sign <- apply(rug[host_groups$sname %in% group2 & host_groups$group == "prime",], 2, calc_consensus_sign)
older_consensus_sign <- apply(rug[host_groups$sname %in% group2 & host_groups$group == "older",], 2, calc_consensus_sign)
universality <- apply(rug[host_groups$sname %in% group2,], 2, calc_universality_score)
univ_threshold <- universality > thresholds_scores$x0[thresholds_scores$type == "ASV"]
prime_universal <- prime_consensus_sign[univ_threshold]
older_universal <- older_consensus_sign[univ_threshold]
confusionMatrix(factor(older_universal),
                factor(prime_universal),
                positive = '1')

# Reference is prime
# 5 pairs are (+) in prime and (-) in older
# 2 pairs are (-) in prime and (+) in older
```

Pairs that are positively correlated in prime age and negatively correlated in
older adult (again, these have low-ish universality scores and it looks like
none are in the overall top 10% most universal):

```{r}
idx <- which(prime_universal > 0 & older_universal < 0)

univ_pairs_df[idx,] %>%
  select(-threshold) %>%
  left_join(data.frame(idx1 = 1:126,
                       order1 = data$taxonomy$order,
                       family1 = data$taxonomy$family,
                       genus1 = data$taxonomy$genus)) %>%
  left_join(data.frame(idx2 = 1:126,
                       order2 = data$taxonomy$order,
                       family2 = data$taxonomy$family,
                       genus2 = data$taxonomy$genus)) %>%
  rowwise() %>%
  mutate(tax1 = paste(order1, family1, genus1),
         tax2 = paste(order2, family2, genus2)) %>%
  select(idx1, idx2, tax1, tax2) %>%
  kbl() %>%
  kable_styling()

# universality[univ_threshold][idx]
```

Pairs that are negatively correlated in prime age and positively correlated in
older adult:

```{r}
idx <- which(prime_universal < 0 & older_universal > 0)

univ_pairs_df[idx,] %>%
  select(-threshold) %>%
  left_join(data.frame(idx1 = 1:126,
                       order1 = data$taxonomy$order,
                       family1 = data$taxonomy$family,
                       genus1 = data$taxonomy$genus)) %>%
  left_join(data.frame(idx2 = 1:126,
                       order2 = data$taxonomy$order,
                       family2 = data$taxonomy$family,
                       genus2 = data$taxonomy$genus)) %>%
  rowwise() %>%
  mutate(tax1 = paste(order1, family1, genus1),
         tax2 = paste(order2, family2, genus2)) %>%
  select(idx1, idx2, tax1, tax2) %>%
  kbl() %>%
  kable_styling()

# universality[univ_threshold][idx]
```

Of these, one pair (ASV7 and ASV24) *was* in the overall top 10% by universality
where it was consensus positively correlated.

Now let's compare the observed correlations between age bins to a distribution
generated by random subsampling of the full series.

```{r}
cor_df1 <- host_groups %>%
  filter(sname %in% group1) %>%
  select(index, sname, group) %>%
  pivot_wider(id_cols = sname, names_from = group, values_from = index)
cor_df1$r <- NA
for(i in 1:nrow(cor_df1)) {
  cor_df1$r[i] <- cor(rug[cor_df1$juvenile[i],], rug[cor_df1$prime[i],])
}

cor_df2 <- host_groups %>%
  filter(sname %in% group2) %>%
  select(index, sname, group) %>%
  pivot_wider(id_cols = sname, names_from = group, values_from = index)
cor_df2$r <- NA
for(i in 1:nrow(cor_df2)) {
  cor_df2$r[i] <- cor(rug[cor_df2$prime[i],], rug[cor_df2$older[i],])
}

cor_df <- rbind(cor_df1 %>%
                  select(sname, r) %>%
                  mutate(groups = "juvenile vs. prime"),
                cor_df2 %>%
                  select(sname, r) %>%
                  mutate(groups = "prime vs. older"))

ggplot(cor_df, aes(x = r, y = groups)) +
  geom_density_ridges(stat = "binline", bins = 20, scale = 0.9, draw_baseline = TRUE) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.75))) +
  theme_bw() +
  labs(x = "correlation of estimates across age bins")
```

Subsample across the whole series to ask: "For random subsamplings of 
approximately the same sample number, how well do estimates of ASV-ASV 
correlation (for the same host) correlate?"

```{r, fig.height = 5, fig.width = 5}
save_fn <- "output/subsampled_r.rds"
if(file.exists(save_fn)) {
  r_samples <- readRDS(save_fn)
} else {
  # Sample in a clustered fashion
  sample_ar <- function(total_N, keep_N, ar = 0.1) {
    yy <- arima.sim(n = total_N, list(ar = c(ar)), sd = 1)
    qq <- quantile(yy, probs = c((total_N - keep_N)/total_N))
    (1:total_N)[as.numeric(yy) >= qq]
  }
  
  # Collect samples
  hosts <- sort(unique(c(group1, group2)))
  n_each <- 10
  r_samples <- c()
  for(sname in hosts[2:length(hosts)]) {
    cat(paste0("Host: ", sname, "\n"))
    for(i in 1:n_each) {
      cat(paste0("\tIteration: ", i, "\n"))
      metadata <- data$metadata
      keep <- which(metadata$sname != sname)
      # host_keep <- sort(sample(which(metadata$sname == sname), size = 35))
      idx <- which(metadata$sname == sname)
      host_keep <- sample_ar(length(idx), 35)
      keep <- c(keep, idx[host_keep])
      metadata_subset <- metadata[keep,]
      counts_subset <- data$counts[,keep]
      
      fit1 <- fit_GP(sname = sname,
                     counts = counts_subset,
                     metadata = metadata_subset,
                     output_dir = "asv_days90_diet25_scale1_test1",
                     MAP = TRUE,
                     days_to_min_autocorrelation = 90,
                     diet_weight = 0.25,
                     # concentration = 100,
                     scramble_sample = F,
                     scramble_spacing = F,
                     scramble_order = F,
                     use_adam = F)
      
      est1 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_test1/MAP/", sname, ".rds")))
      sigma1 <- cov2cor(est1$Sigma[1:125,1:125,1])
      
      keep <- which(metadata$sname != sname)
      keep <- c(keep, sort(sample(which(metadata$sname == sname), size = 35)))
      metadata_subset <- metadata[keep,]
      counts_subset <- data$counts[,keep]
      
      fit2 <- fit_GP(sname = sname,
                     counts = counts_subset,
                     metadata = metadata_subset,
                     output_dir = "asv_days90_diet25_scale1_test2",
                     MAP = TRUE,
                     days_to_min_autocorrelation = 90,
                     diet_weight = 0.25,
                     # concentration = 100,
                     scramble_sample = F,
                     scramble_spacing = F,
                     scramble_order = F,
                     use_adam = F)
      
      est1 <- fido::to_clr(readRDS(paste0("output/model_fits/asv_days90_diet25_scale1_test2/MAP/", sname, ".rds")))
      sigma2 <- cov2cor(est1$Sigma[1:125,1:125,1])
      
      r <- cor(c(sigma1[lower.tri(sigma1, diag = F)]), c(sigma2[lower.tri(sigma2, diag = F)]))
      r_samples <- c(r_samples,
                     cor(c(sigma1[lower.tri(sigma1, diag = F)]), c(sigma2[lower.tri(sigma2, diag = F)])))
    }
  }
}

ggplot(data.frame(x = r_samples), aes(x = x)) +
  geom_histogram(color = "white") +
  theme_bw() +
  labs(x = "correlation of subsampled estimates")
```

Having extracted two subsampled series for each host 10 times, we can build a 
null distribution of "randomly" generated correlations across subsampled series
from these hosts.

If there are really different age-based regimes of correlation, we might expect
that correlation across age bins (`cor_df$r`) will be on the very low end of the
null distribution of correlations - i.e. across-age series are maximally 
dissimilar.

We do seem to see that: over half (15/26) of the observed correlations are below
the 5th percentile of the null distribution and ZERO of the observed 
correlations are above the median of the null distribution.

```{r}
cor_df$quantile <- ecdf(r_samples)(cor_df$r)
cor_df$lower_than_expected <- cor_df$quantile < 0.05
cor_df
```

```{r}
# ggplot(cor_df, aes(x = quantile)) +
#   geom_histogram(color = "white", bins = 30) +
#   theme_bw() +
#   xlim(c(0,1)) +
#   labs(x = "quantile obs. r in null r distribution")

ggplot(cor_df, aes(x = 1:nrow(cor_df), y = quantile, fill = groups)) +
  geom_segment(aes(x = 0, xend = nrow(cor_df), y = 0.05, yend = 0.05),
               linetype = "dashed") +
  geom_point(size = 3, shape = 21) +
  theme_bw() +
  labs(x = "quantile obs. r in null r distribution")
```



